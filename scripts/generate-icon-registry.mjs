#!/usr/bin/env node
/**
 * Pre-generates the icon registry for the library build.
 * This replaces the Webpack-specific require.context with explicit static imports
 * that work with Rollup and in any consuming project.
 */

import { readdirSync, statSync, writeFileSync, mkdirSync, existsSync } from 'fs';
import { join, relative, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const ICONS_DIR = join(__dirname, '../src/icons');
const OUTPUT_FILE = join(__dirname, '../src/icons/iconRegistry.generated.js');

// Directories/files to skip
const SKIP = new Set(['index.js', 'iconRegistry.generated.js', 'AllIcons.java', 'README.md', 'Update icons by Bulat 2025-12-08.md']);

/**
 * Recursively find all SVG files in a directory
 */
function findSvgFiles(dir, basePath = '') {
    const results = [];
    const entries = readdirSync(dir);

    for (const entry of entries) {
        if (SKIP.has(entry)) continue;

        const fullPath = join(dir, entry);
        const relativePath = basePath ? `${basePath}/${entry}` : entry;

        const stat = statSync(fullPath);
        if (stat.isDirectory()) {
            results.push(...findSvgFiles(fullPath, relativePath));
        } else if (entry.endsWith('.svg')) {
            results.push(relativePath);
        }
    }

    return results;
}

/**
 * Convert a file path to a valid JavaScript variable name
 */
function toVariableName(filePath) {
    // Remove .svg extension
    const name = filePath.replace(/\.svg$/, '');
    // Replace slashes and special characters with underscores
    // Handle @2x, @3x etc suffixes and other special characters
    return 'icon_' + name
        .replace(/\//g, '_')
        .replace(/@/g, '_at_')
        .replace(/-/g, '_')
        .replace(/\./g, '_')
        .replace(/=/g, '_eq_')
        .replace(/,/g, '_')
        .replace(/ /g, '_')
        .replace(/\(/g, '_')
        .replace(/\)/g, '_')
        .replace(/\+/g, '_plus_')
        .replace(/[^a-zA-Z0-9_]/g, '_');
}

/**
 * Convert a file path to the registry key (matches the original format)
 */
function toRegistryKey(filePath) {
    return filePath.replace(/\.svg$/, '');
}

function main() {
    console.log('ðŸ” Scanning for SVG icons...');
    
    const svgFiles = findSvgFiles(ICONS_DIR);
    console.log(`ðŸ“¦ Found ${svgFiles.length} SVG icons`);

    // Generate imports
    const imports = svgFiles.map(file => {
        const varName = toVariableName(file);
        return `import ${varName} from './${file}';`;
    });

    // Generate registry object
    const registryEntries = svgFiles.map(file => {
        const varName = toVariableName(file);
        const key = toRegistryKey(file);
        return `  '${key}': ${varName}`;
    });

    const output = `// AUTO-GENERATED FILE - DO NOT EDIT
// Generated by scripts/generate-icon-registry.mjs
// This file contains static imports for all icons to avoid require.context

${imports.join('\n')}

const iconRegistry = {
${registryEntries.join(',\n')}
};

export const iconNames = Object.keys(iconRegistry).sort();

export const getIcon = (name) => iconRegistry[name];

export default iconRegistry;
`;

    writeFileSync(OUTPUT_FILE, output, 'utf8');
    console.log(`âœ… Generated ${OUTPUT_FILE}`);
    console.log(`   ${svgFiles.length} icons registered`);
}

main();

